Wu={Views:{},Models:{},Collections:{},Cache:{Models:{},Views:{},Collections:{}},Routers:{},init:function(){window.Socket=io.connect(":3000"),this.Cache.Models.category=new Wu.Models.category,this.Cache.Models.directory=new Wu.Models.directory,this.Cache.Models.player=new Wu.Models.player,this.Cache.Collections.renderers=new Wu.Collections.renderers,Wu.Cache.Categories=new Wu.Routers.Categories,Wu.Cache.Collections.playlists=new Wu.Collections.playlists,Wu.Cache.Collections.servers=new Wu.Collections.servers,Wu.Cache.Views.toastMaster=new Wu.Views.toastMaster,this.Cache.Collections.servers.reset(bootstrapServers),this.Cache.Collections.renderers.reset(bootstrapRenderers),this.Cache.Collections.playlists.reset(bootstrapPlaylists),$(document).on("click","a:not(.data-bypass)",function(e){e.preventDefault(),Backbone.history.navigate($(e.target).attr("href"),{trigger:!0})}),$(document).on("swipeRight",".category",function(){window.history.back()}),Wu.Layout.init(),Backbone.history.start({pushState:!0})}},$(document).ready(function(){window.Wu=Wu,Wu.init()});var Drawer=function(){function e(e){return e.touches?e.touches[0].pageY:e.pageY}function t(e){return e.touches?e.touches[0].pageX:e.pageX}function i(e){var t=e.touches?e.touches[0].pageX:e.pageX,i=e.touches?e.touches[0].pageY:e.pageY,n=t-c.offset().left,s=i-c.offset().top;b&&s>a&&o>s&&r>n&&n>l&&(p=e.timeStamp,d="horizontal"==h.drag?t:i,f=!0)}function n(e){if(f){e.preventDefault();var t=u(e),i=0===d?0:Math.abs(t-d),n=h.maxTime,s=h.maxDistance;if(currentTime=e.timeStamp,0!==p&&n>currentTime-p&&i>s){if(d>t){var o="horizontal"==h.drag?"left":"up";c.trigger(o)}if(t>d){var o="horizontal"==h.drag?"right":"down";c.trigger(o),f=!1}p=0,d=0}}else"full"==m?e.preventDefault():"partial"==m&&(e.overide||e.preventDefault())}function s(){p=0,d=0,f=!1}var o,r,a,l,c,u,h={maxTime:1e3,maxDistance:20,scopeEl:$("html"),xPadding:0,yPadding:0,drag:"horizontal"},d=0,p=0,f=!1,m=!1,g="ontouchend"in document,v=g?"touchstart":"mousedown",w=g?"touchmove":"mousemove",y=g?"touchend":"mouseup",b=!0;return{init:function(d){if($.extend(h,d),c=$(h.el),!c||1>c.length)throw"Error: Need to supply a valid target element";a=h.yPadding,l=h.xPadding,r=c.width()+l,o=c.height()+a,h.scopeEl.on(v,i).on(w,n).on(y,s),u="horizontal"==h.drag?t:e,$(".nots").bind(w,function(e){e.xyz=!0}),c.on("toggleDrag",function(e,t){b=void 0===t?!b:t})},toggle:function(e){f=e},lockScroll:function(e){m=e}}}();Wu.Layout={init:function(){this.header=new Wu.Views.header({el:$("#header")}),this.menu=new Wu.Views.menu({collection:Wu.Cache.Collections.renderers,el:$("#menu")}).render(),this.menu.trigger("inserted"),this.footer=new Wu.Views.playerTab({model:Wu.Cache.Models.player,el:$("#pullTab")}).render(),this.footer.trigger("inserted")},setSubHeader:function(e){this.header.setSubHeader(e),this.header.render()},removeSubHeader:function(){this.header.removeSubHeader()},setPage:function(e){this.page&&this.page.unrender(),this.menu.hide(),$("#mask").hide(),$("#page").html(e.render().$el),e.trigger("inserted"),this.page=e}},function(e){function t(e,t,i){function n(){var i=t.blocks;t.blocks={};var n=o.capture(t,t.length,e());return t.blocks=i,n}return i?n():h.isolate(n)}function i(e,t,i){i&&(e.filename=t.filename,e.source=t.source),e.line=t.line,e.col=t.col}function n(e,t,i){var n=e.buf.splice(i,e.buf.length-i);Array.prototype.unshift.apply(e.buf,n);for(var s in t.blocks)t.blocks[s].parent==e&&t.blocks[s].pos>=i&&(t.blocks[s].pos-=i)}function s(e,t){for(var i=e+" ",n=0;t-i.length+1>n;n++)i=" "+i;return i}var o="object"==typeof exports?exports:{},r={},a={},l=function(e,t){return t},c=function(e){return e()},u=function(e,t){return t()},h={attachEvents:l,setDataContext:l,isolate:c,render:c,list:function(e,t,i){var n=[];if(e.observe({added:function(e){n.push(e)}}).stop(),!n.length)return i();for(var s="",o=0;n.length>o;o++)s+=t(n[o]);return s},labelBranch:u,createLandmark:u,finalize:l};o.options={mount:"/views/",loadTimeout:15e3},(o.client="undefined"!=typeof window)&&(window.blade={Runtime:o,LiveUpdate:h,_cachedViews:r,_cb:{},runtime:o}),o.escape=function(e){return null==e?"":new String(e).replace(/&(?!([a-zA-Z]+|(#[0-9]+)|(#[xX][0-9a-fA-F]+));)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},o.attrs=function(e,t){for(var i in e){var n=e[i];if(null==n.v||n.v===!1){if(null==n.a)continue;n.v=n.a,delete n.a}n.v===!0&&(n.v=i),"class"==i&&(n.v instanceof Array&&(n.v=n.v.join(" ")),n.a&&(n.v=(n.v.length>0?n.v+" ":"")+n.a)),n.e?t.push(" "+i+'="'+o.escape(n.v)+'"'):t.push(" "+i+'="'+n.v+'"')}},o.ueid=o.client?1e3:0,o.bind=function(e,t,i,n,s){for(var o="",r=e.split(" "),l=0;r.length>l;l++)o=","+r[l]+" #"+t;a[o.substr(1)]=i;var c="i["+JSON.stringify(e)+"]="+(""+i);if(s){var l=n.length-1;n[l]=n[l].substr(0,n[l].length-3)+";"+c+"-->"}else n.push("<!--"+c+"-->")},o.trigger=e,o.loadTemplate=function(e,t,i,n){function s(e,i){for(var n=0;e.length>n;n++)i?e[n](i):e[n](null,r[t])}function a(e){var i=l._cb[t].cb;delete l._cb[t],c.parentNode.removeChild(c),s(i,Error("Blade Template ["+t+"] could not be loaded: "+(e?e:"Request timed out")))}if("function"==typeof i&&(n=i,"object"==typeof t?(i=t,t=e,e=""):i=null),"function"==typeof t&&(n=t,t=e,i=null,e=""),0>t.split("/").pop().indexOf(".")&&(t+=".blade"),o.client){if(t=o.resolve(t),r[t])return n(null,r[t]),!0;var l=window.blade;if(l._cb[t])l._cb[t].cb.push(n);else{var c=document.createElement("script");c.type="text/javascript",c.async=!0,c.src=o.options.mount+t;var u=setTimeout(a,o.options.loadTimeout),h=l._cb[t]=function(n,r){if(clearTimeout(u),delete l._cb[t],c.parentNode.removeChild(c),r.length>0)for(var a=0,d=0;r.length>d;d++)o.loadTemplate(e,n+"/"+r[d],i,function(e){return e?s(h.cb,e):(++a==r.length&&s(h.cb),void 0)});else s(h.cb)};h.cb=[n];var d=document.getElementsByTagName("script")[0];d.parentNode.insertBefore(c,d),c.onload=c.onreadystatechange=c.onerror=function(){var e=this.readyState;e&&"loaded"!=e&&"complete"!=e||!l._cb[t]||(clearTimeout(u),a("Request failed"))}}return!1}return i.synchronous=!0,require("./blade").compileFile(e+"/"+t,i,function(e,t){return e?n(e):(n(null,t.template),void 0)}),!0},o.resolve=function(e){if(o.client){var t=document.createElement("div");t.innerHTML='<a href="'+o.escape("./"+e)+'"></a>',t=t.firstChild.href;var i=window.location.href.split("#")[0];return t=t.substr(i.substr(0,i.lastIndexOf("/")).length).replace(/\/[\/]+/g,"/"),"/"==t.charAt(0)&&(t=t.substr(1)),t}},o.include=function(e,t){var i=t.inc,n=t.base,s=t.rel,r=t.filename,a=t.line,l=t.col,c=t.source,u=t.locals;if(t.inc=!0,arguments.length>2){t.locals={};for(var d=2;arguments.length>d;d+=2)t.locals[arguments[d]]=arguments[d+1]}var p=o.loadTemplate(t.base,t.rel+"/"+e,o.compileOptions,function(d,p){if(d)throw d;var f=t.length;p(t.locals,function(d,p){if(d)throw d;t.inc=i,t.base=n,t.rel=s,t.filename=r,t.line=a,t.col=l,t.source=c,t.locals=u,t.bd||(p=o.capture(t,f),t.push(h.labelBranch(t.filename+":"+t.line+":inc:"+e,function(){return p})))},t)});if(!p)throw Error("Included file ["+t.rel+"/"+e+"] could not be loaded synchronously!")},o.func=function(e,t,i){var n=i.func[e]=t;n.filename=i.filename,n.source=i.source},o.call=function(e,t,i){var n=i.func[e],s=[i];if(null==n)throw Error("Function '"+e+"' is undefined.");for(var o=3;arguments.length>o;o++)s[o-2]=arguments[o];var r=i.filename,a=i.source;i.filename=n.filename,i.source=n.source,n.apply(t,s),i.filename=r,i.source=a},o.capture=function(e,t){for(var i in e.blocks){var n=e.blocks[i];n.pos>=t&&(!e.block||n.parent==e.block)&&(null==n.parent?e[n.pos]=n.buf.join(""):(n.parent.buf[n.pos]=n.buf.join(""),n.parent.numChildren--),delete e.blocks[i])}return e.splice(t,e.length-t).join("")},o.chunk=function(e,t,i){i.chunk[e]=function(){return o.capture(i,i.length,t.apply(this,arguments))}},o.isolate=function(e,i){i.push(t(e,i))},o.constant=function(e,t,i){i.push(h.labelBranch(i.filename+":"+e,function(){return h.createLandmark({constant:!0},function(){return o.capture(i,i.length,t())})}))},o.preserve=function(e,t,i,n){n.push(h.labelBranch(n.filename+":"+e,function(){return h.createLandmark({preserve:t},function(){return o.capture(n,n.length,i())})}))},o.foreach=function(e,i,n,s){function o(i){var s=i._id||("string"==typeof i?i:null)||h.UNIQUE_LABEL;return h.labelBranch(s,function(){return t(function(){return n.call(i,i)},e,a)})}function r(){return h.labelBranch("else",function(){return s?t(s,e,a):""})}var a=!1;if(i&&"observe"in i)e.push(h.list(i,o,r));else{a=!0;var l="",c=1;for(var u in i)c=0,l+=o(i[u]);e.push(c?r():l)}},o.blockDef=function(e,t,n){var s=t.blocks[e]={parent:t.block||null,buf:[],pos:t.length,numChildren:0},o=["r","blocks","func","locals","cb","base","rel","filename","source"];for(var r in o)s.buf[o[r]]=t[o[r]];if(s.buf.block=s,s.parent&&s.parent.numChildren++,t.push(""),n.length>1)s.paramBlock=n;else try{n(s.buf)}catch(a){throw i(t,s.buf),a}},o.blockRender=function(e,t,s){var o=s.blocks[t];if(null==o)throw Error("Block '"+t+"' is undefined.");if(null==o.paramBlock)throw Error("Block '"+t+"' is a regular, non-parameterized block, which cannot be rendered.");for(var r=[o.buf],a=3;arguments.length>a;a++)r[a-2]=arguments[a];"r"==e&&(o.buf.length=0);var l=o.buf.length;try{o.paramBlock.apply(this,r)}catch(c){throw i(s,o.buf,1),c}"p"==e&&n(o,s,l)},o.blockMod=function(e,t,s,o){var r=s.blocks[t];if(null==r)throw Error("Block '"+t+"' is undefined.");"r"==e&&(delete r.paramBlock,r.buf.length=0);var a=r.buf.length;if(o.length>1)r.paramBlock=o;else try{r.buf.rel=s.rel,r.buf.base=s.base,o(r.buf)}catch(l){throw i(s,r.buf),l}"p"==e&&n(r,s,a)},o.done=function(e){for(var t=!1;!t;){t=!0;for(var i in e.blocks){var n=e.blocks[i];n.done||0!=n.numChildren||(t=!1,null==n.parent?e[n.pos]=n.buf.join(""):(n.parent.buf[n.pos]=n.buf.join(""),n.parent.numChildren--),n.done=!0)}}e.eventHandlers=a,a={},o.client||(o.ueid=0)},o.rethrow=function(e,t){if(null==t&&(t=e),e.lastFilename==t.filename&&null!=e.lastFilename)return e;t.column=t.column||t.col;var i=e.message+"\n    at "+(null==t.filename?"<anonymous>":t.filename)+(null==t.line?"":":"+t.line+(null==t.column?"":":"+t.column));if(null!=t.source){var n=3,o=t.source.split("\n"),r=Math.max(t.line-n,0),a=Math.min(t.line+n,o.length),l=new String(a).length;o=o.slice(r,a),i+="\n\n";for(var c=0;o.length>c;c++)i+=s(c+r+1,l)+(c+r+1==t.line?">	":"|	")+o[c]+"\n"}return e.message=i,e.lastFilename=t.filename,null==e.filename&&null==e.line&&(e.filename=t.filename,e.line=t.line,e.column=t.column),e}}(function(e,t){var r=e.previousSibling,i={},h,n;eval(r.textContent),e.parentNode.removeChild(r);for(r in i)for(h=r.split(" "),n=0;h.length>n;n++)e["on"+h[n]]=i[r];return e["on"+t[0].type].apply(e,t)}),function(e){function t(e){return"tagName"in e?e:e.parentNode}function i(e,t,i,n){var s=Math.abs(e-t),o=Math.abs(i-n);return s>=o?e-t>0?"Left":"Right":i-n>0?"Up":"Down"}function n(){c=null,u.last&&(u.el.trigger("longTap"),u={})}function s(){c&&clearTimeout(c),c=null}function o(){r&&clearTimeout(r),a&&clearTimeout(a),l&&clearTimeout(l),c&&clearTimeout(c),r=a=l=c=null,u={}}var r,a,l,c,u={},h=750;e(document).ready(function(){var d,p;e(document.body).bind("touchstart",function(i){d=Date.now(),p=d-(u.last||d),u.el=e(t(i.touches[0].target)),r&&clearTimeout(r),u.x1=i.touches[0].pageX,u.y1=i.touches[0].pageY,p>0&&250>=p&&(u.isDoubleTap=!0),u.last=d,c=setTimeout(n,h)}).bind("touchmove",function(e){s(),u.x2=e.touches[0].pageX,u.y2=e.touches[0].pageY,Math.abs(u.x1-u.x2)>10&&e.preventDefault()}).bind("touchend",function(){s(),u.x2&&Math.abs(u.x1-u.x2)>30||u.y2&&Math.abs(u.y1-u.y2)>30?l=setTimeout(function(){u.el.trigger("swipe"),u.el.trigger("swipe"+i(u.x1,u.x2,u.y1,u.y2)),u={}},0):"last"in u&&(a=setTimeout(function(){var t=e.Event("tap");t.cancelTouch=o,u.el.trigger(t),u.isDoubleTap?(u.el.trigger("doubleTap"),u={}):r=setTimeout(function(){r=null,u.el.trigger("singleTap"),u={}},250)},0))}).bind("touchcancel",o),e(window).bind("scroll",o)}),["swipe","swipeLeft","swipeRight","swipeUp","swipeDown","doubleTap","tap","singleTap","longTap"].forEach(function(t){e.fn[t]=function(e){return this.bind(t,e)}})}(Zepto),Wu.Views.list=Backbone.View.extend({template:JST["category.show"],initialize:function(e){e&&e.noJumper||(this.jumper=new Wu.Views.listJumper({list:this.$el,el:$("#alphabet")}),this.$el.on("click",".jumper",$.proxy(this.jumper.show,this.jumper)))},render:function(){var e=this;return this.template({model:this.model,jumper:this.jumper},function(t,i){e.$el.html(i),e.jumper&&e.jumper.render();var n=e.$(".title")[0]||e.$("li")[0];n&&n.scrollIntoView()}),this},unrender:function(){this.jumper&&this.jumper.unrender()}}),Wu.Views.categories=Backbone.View.extend({template:JST["category.container"],initialize:function(){this.list=new Wu.Views.categoryList({model:this.model,className:"category",parent:this}),this.popup=new Wu.Views.categoryPopup({collection:Wu.Cache.Collections.playlists,model:this.model,className:"popup"}),this.listenTo(this.model,"change:id",function(){this.model.fetch()}),this.listenTo(this.list,"showPopup",function(){this.popup.show()}),this.listenTo(this.list,"rendered",function(){this.popup.hide()}),this.listenTo(this,"tracksInserted",this.tracksInserted)},render:function(){var e=this;return this.template({},function(t,i){e.$el.html(i).append(e.popup.render().$el),e.$("#category-container").html(e.list.render().$el)}),this},unrender:function(){this.stopListening(),this.list.unrender()},tracksInserted:function(){this.model.fetch()}}),Wu.Views.categoryList=Wu.Views.list.extend({ORDER:["Artist","Album","Title"],infoTemplate:JST["category.info"],events:{"click .category-list li:not(.jumper)":"select","click .title":"showPopup"},initialize:function(e){Wu.Views.list.prototype.initialize.call(this,e),e.url?this.url=e.url:(this.url="category/",this.isCategory=!0),this.listenTo(this.model,"change:docs",this.render),this.listenTo(Wu.Cache.Collections.servers,"add remove",function(){this.isCategory&&!Wu.Cache.Collections.servers.pathSet&&this.render()})},render:function(){var e=this;return this.model.get("docs"),!this.isCategory||Wu.Cache.Collections.servers.pathSet?(Wu.Views.list.prototype.render.call(this),$("#mask").hide(),this.trigger("rendered")):this.infoTemplate({servers:Wu.Cache.Collections.servers},function(t,i){e.$el.html(i),$("#mask").show()}),this},unrender:function(){Wu.Views.list.prototype.unrender.call(this),this.$el.off(),this.stopListening()},select:function(e){var t=this.model.filter($(e.target).text(),e.target.id);t?Backbone.history.navigate(this.url+t,{trigger:!0}):this.trigger("showPopup")},showPopup:function(e){e.preventDefault(),this.trigger("showPopup")}}),Wu.Views.categoriesNav=Backbone.View.extend({template:JST["category.nav"],initialize:function(){this.listenTo(this.model,"change:id",this.updateActive)},render:function(){var e=this;return this.template({},function(t,i){e.$el.html(i),e.updateActive({},e.model.get("id"))}),this},unrender:function(){this.stopListening()},updateActive:function(e,t){this.$(".active").removeClass("active"),this.$("."+t).addClass("active")}}),Wu.Views.categoryPopup=Backbone.View.extend({template:JST["category.popup"],events:{"click h1.play i":"playNow","click h1.play .next":"playNext","click h1.add":"showAddTo","click h1.new":"showCreate","click span.new":"showCreate","click .cancel":"back","submit .bottom-box.new form":"createList","click .bottom-box.add li":"addToList"},render:function(){var e=this;return this.template({},function(t,i){e.$el.html(i),e.setHeight()}),this},unrender:function(){var e=this.model.get("filter");e&&delete e._id,$("#mask").off("click",$.proxy(this.hide,this))},setHeight:function(){var e=$(window).height()-Math.round(.11*$(window).height())-100;e=Math.min(500,e),this.$(".bottom-box").css("max-height",e)},generateList:function(){if(this.collection.length){var e="<ul>";this.collection.each(function(t){e+="<li listId='"+t.get("_id")+"'>"+t.get("name")+"</li>"}),e+="</ul>"}else var e="No exisiting playlists, <span class='new'>create one</span> to continue";return e},showAddTo:function(){this.$el.addClass("add expand"),this.collection.fetch({success:$.proxy(function(){this.$(".bottom-box.add").html(this.generateList())},this)})},showCreate:function(){this.$el.removeClass("add").addClass("new expand"),this.$("input.name").val("")},back:function(){this.$el.hasClass("expand")?this.$el.removeClass("new add expand"):this.hide()},show:function(){$("#mask").show(),$("#mask").on("click",$.proxy(this.hide,this)),this.$el.show()},hide:function(){$("#mask").hide(),$("#mask").off("click",$.proxy(this.hide,this)),this.$el.hide(),this.$el.removeClass("new add expand");var e=this.model.get("filter");e&&delete e._id},createList:function(e){e.preventDefault();var t=this.$(".bottom-box.new .name")[0].value;if(""==t)alert("please enter a name");else{var i=new Wu.Models.playlist({name:t}),n=this.model.get("filter");i.set("filter",n),i.save(null,{success:$.proxy(function(e){var i='Playlist "'+t+'" created with '+e.get("added")+" tracks";this.collection.add(e),Wu.Cache.Views.toastMaster.message(i)},this),error:function(e,t){var i=t.responseText;Wu.Cache.Views.toastMaster.error(i)}}),i.set("filter",!1),this.hide()}},playNow:function(){var e=Wu.Cache.Models.player.get("quickList"),t=this.collection.get(e);return t?(t.set("clearAfter",0),this._add(t,function(){Socket.emit("playPlaylist",e)}),void 0):(Wu.Cache.Views.toastMaster.error("Must select a media renderer first"),void 0)},playNext:function(){var e=Wu.Cache.Models.player,t=e.get("quickList"),i=this.collection.get(t),n=e.get("currentPlayingTrack"),s=(e.get("playlist"),n?n.position:0);return i?(i.set("clearAfter",s),this._add(i),void 0):(Wu.Cache.Views.toastMaster.error("Must select a media renderer first"),void 0)},addToList:function(e){var t=$(e.target).attr("listId"),i=this.collection.get(t);this._add(i)},_add:function(e,t){var i=this.model.get("filter");e.set("filter",i),e.save(null,{success:function(i){var n=i.get("added")+' tracks added to "'+e.get("name")+'" playlist';Wu.Cache.Views.toastMaster.message(n),"function"==typeof t&&t()},error:function(e,t){var i=t.responseText;Wu.Cache.Views.toastMaster.error(i)}}),e.unset("filter"),e.unset("clearAfter"),this.hide()}}),Wu.Views.directories=Backbone.View.extend({template:JST["directory.container"],events:{"click .popup .ok":"chooseDirectory","click .popup .cancel":"hidePrompt"},initialize:function(){this.list=new Wu.Views.categoryList({model:this.model,className:"category",url:"directory/",noJumper:!0,parent:this}),this.listenTo(this.model,"change:id",function(){this.model.fetch({error:function(e,t){Wu.Cache.Views.toastMaster.error(t.responseText),window.history.back()}})}),this.listenTo(this.list,"showPopup",this.showPrompt)},render:function(){var e=this;return this.template({},function(t,i){e.$el.html(i),e.$("#category-container").html(e.list.render().$el)}),this},unrender:function(){this.stopListening(),this.list.unrender()},showPrompt:function(){$("#mask").show(),this.$(".popup").show()},hidePrompt:function(){$("#mask").hide(),this.$(".popup").hide()},chooseDirectory:function(){var e,t=this.model.get("uuid"),i=this.model.get("id"),n=Wu.Cache.Collections.servers.get(t),s=this.model.getTitle();n&&(e=n.get("name"),n.save({path:i},{success:function(){Wu.Cache.Views.toastMaster.message('Adding tracks in "'+s+'" from "'+e+'"')},error:function(e){Wu.Cache.Views.toastMaster.error(e.responseText)}}),Backbone.history.navigate("/",{trigger:!0}))}}),Wu.Views.header=Backbone.View.extend({template:JST.header,events:{"click .menuLink":"toggleMenu"},initialize:function(){var e=this;this.template({},function(t,i){e.$el.html(i)})},render:function(){return this.subHeader&&this.subHeader.render(),this},unrender:function(){this.subHeader&&this.subHeader.unrender()},setSubHeader:function(e){this.subHeader&&this.subHeader.unrender(),this.subHeader=e,this.$("#subnav").html(this.subHeader.render().$el)},removeSubHeader:function(){this.subHeader&&(this.subHeader.unrender(),this.subHeader.remove())},toggleMenu:function(){this.trigger("menuClick")}}),Wu.Views.listJumper=Backbone.View.extend({events:{"click .back":"hide","click span.active":"jump"},initialize:function(e){this.$listEl=$(e.list),this.secret=Math.random()},render:function(){return this.$el.html(this.setupJumper()),this},unrender:function(){this.$el.off(),$("#mask").off("click",$.proxy(this.hide,this))},setupJumper:function(){for(var e,t="<div class='back icon-chevron-left'></div>",i=65;91>i;i++)e=String.fromCharCode(i),t+=this.$listEl.find("#jumper"+e).length>0?'<span class="active">'+e+"</span>":'<span class="greyed">'+e+"</span>";return t},jump:function(e){console.log(this.secret);var t=$(e.target).html();this.$listEl.find("#jumper"+t)[0].scrollIntoView(),this.hide()},show:function(){this.$el.addClass("flipOut"),$("#mask").on("click",$.proxy(this.hide,this)),$("#mask").show()},hide:function(){this.$el.removeClass("flipOut"),$("#mask").off("click",$.proxy(this.hide,this)),$("#mask").hide()}}),Wu.Views.menu=Backbone.View.extend({template:JST.menu,events:{"click .renderers li":"setRenderer","click .musicLink":"gotoMusic"},initialize:function(){this.listenTo(Wu.Layout.header,"menuClick",this.show),this.listenTo(this.collection,"add remove reset",this.render),this.listenTo(Wu.Cache.Collections.servers,"add remove reset",this.render),this.listenTo(Wu.Cache.Collections.playlists,"add remove reset",this.render),this.listenTo(this,"hideMusic",this.hideMusic),this.listenTo(this,"showMusic",this.showMusic),this.listenTo(this,"inserted",this.setupDrag),this.listenTo(Wu.Cache.Models.player,"change:id",this.setActive),this.listenTo(Wu.Cache.Models.player,"change:playlist",this.setActive),this.listenTo(Wu.Cache.Models.player,"change:TransportState",this.setActive),this.$el.on("click","a",$.proxy(this.hide,this))},render:function(){var e=this;return this.template({playlists:Wu.Cache.Collections.playlists,renderers:this.collection,servers:Wu.Cache.Collections.servers},function(t,i){e.$el.html(i),e.showMusicLink&&e.showMusic(),e.setActive()}),this},unrender:function(){$("#mask").off("click",$.proxy(this.hide,this)),this.stopListening()},setupDrag:function(){var e=this;Drawer.init({el:this.$el}),this.$el.on("left",function(){e.$el.css("left","-100%")}),this.$el.on("right",function(){e.$el.css("left","0%")})},show:function(){this.$el.removeClass("hide"),$("#mask").show().on("click",$.proxy(this.hide,this))},hide:function(){this.$el.addClass("hide"),$("#mask").hide().off("click",$.proxy(this.hide,this))},setRenderer:function(e){var t=$(e.currentTarget).attr("id");Wu.Cache.Models.player.setRenderer(t),this.hide()},hideMusic:function(){this.$(".musicLink").hide(),this.showMusicLink=!1},showMusic:function(){this.$(".musicLink").show(),this.showMusicLink=!0},gotoMusic:function(){var e=Wu.Cache.Models.category.get("id")||"Artist";this.hide(),Backbone.history.navigate("/category/"+e,{trigger:!0})},setActive:function(){var e=Wu.Cache.Models.player.id,t=Wu.Cache.Models.player.get("playlist"),i="PLAYING"===Wu.Cache.Models.player.get("TransportState");this.$("li").removeClass("active"),t&&$("#"+t)[i?"addClass":"removeClass"]("active"),e&&$("#"+e).addClass("active")}}),Wu.Views.playerTab=Backbone.View.extend({template:JST["player.tab"],events:{"click .icon-play":"play","click .icon-pause":"pause","click .next":"next","mousedown .ball":"dragStart","touchstart .ball":"dragStart"},initialize:function(){this.listenTo(this.model,"change:currentPlayingTrack",this.changeTrack),this.listenTo(this.model,"change:TransportState",this.changePlayState),this.listenTo(this,"inserted",this.setupDrag),this.lastTime=Date.now(),this.animator=this.animateProgress.bind(this),this.animateProgress(),this.listenTo($(document),"mousemove touchmove",$.proxy(this.drag,this)),this.listenTo($(document),"mouseup touchend",$.proxy(this.dragEnd,this)),this.listenTo(this.$el,"mousedown",function(e){e.preventDefault()}),this.listenTo($(window),"resize",$.proxy(function(){this.width=this.$el.width()-50},this)),this.animate=!0},render:function(){var e=this;return this.template({model:this.model},function(t,i){e.$el.html(i),e.changeTrack(e.model,e.model.get("currentPlayingTrack")),e.changePlayState(e.model,e.model.get("TransportState")),e.setPosition(e.model.get("trackPosition"))}),this},unrender:function(){this.stopListening()},animateProgress:function(){if(this.animate&&!this.dragging&&"PLAYING"===this.model.get("TransportState")){var e=this.model.get("trackPosition");this.setPosition(e),this.model.set("trackPosition",e+Date.now()-this.lastTime)}this.lastTime=Date.now(),window.requestAnimationFrame(this.animator)},setPosition:function(e){var t=this.width*(e/this.model.get("duration"));this.$(".ball").css("-webkit-transform","translate3d("+t+"px,0,0)")},dragStart:function(e){this.dragging=!0,e.preventDefault()},drag:function(e){if(this.dragging){var t=e.pageX||e.touches[0].pageX;this.lastX=t,this.$(".ball").css("-webkit-transform","translateZ(0) translateX("+t+"px)")}},dragEnd:function(){if(this.dragging){var e=this.lastX/this.width*this.model.get("duration");Socket.emit("setPosition",e)}this.dragging=!1,this.animate=!1;var t=this;setTimeout(function(){t.animate=!0},1e3)},setupDrag:function(){var e=this;this.width=this.$el.width()-50,Drawer.init({el:this.$el}),this.$el.on("left",function(){e.$el.css("left","0%")}),this.$el.on("right",function(){e.dragging||e.$el.css("left","100%")})},play:function(){Socket.emit("play")},pause:function(){Socket.emit("pause")},next:function(){Socket.emit("next")},changeTrack:function(e,t){var i=t&&t.Title?t.Title:"Unknown";if(this.$(".title").html(i).attr("href","/playlist/"+e.get("playlist")),t){var n=new DOMParser,s=n.parseFromString(t.Didl,"text/xml"),o=s.getElementsByTagName("albumArtURI")[0];if(o){var r=o.childNodes[0].nodeValue;r!=this.albumArt&&($("body").css("background-image","url("+r+")"),this.albumArt=r)}}},changePlayState:function(e,t){"PLAYING"===t?(this.$(".ball").show(),this.$(".play").removeClass("icon-play").addClass("icon-pause")):(this.$(".ball")["PAUSED_PLAYBACK"===t?"show":"hide"](),this.$(".play").removeClass("icon-pause").addClass("icon-play"))}}),Wu.Views.playlistDropdown=Backbone.View.extend({template:JST["playlist.dropdown"],events:{"click .opened .current":"hide","click .current":"show"},render:function(){var e=this;return this.template({currentList:this.model,playlists:Wu.Cache.Collections.playlists},function(t,i){e.$el.html(i)}),this},unrender:function(){$("#mask").off("click",$.proxy(this.hide,this)),this.stopListening()},show:function(e){$("#mask").show(),$("#mask").on("click",$.proxy(this.hide,this)),this.$(".dropDown").addClass("opened"),this.$(".down").removeClass("icon-angle-down").addClass("icon-angle-up"),e.stopImmediatePropagation()},hide:function(e){$("#mask").hide(),$("#mask").off("click",$.proxy(this.hide,this)),this.$(".dropDown").removeClass("opened"),this.$(".down").removeClass("icon-angle-up").addClass("icon-angle-down"),e.stopImmediatePropagation()}}),Wu.Views.toastMaster=Backbone.View.extend({initialize:function(){this.listenTo(Wu.Cache.Collections.renderers,"add",function(e){this.message('New media renderer "'+e.get("name")+'" detected')},this),this.listenTo(Wu.Cache.Collections.renderers,"remove",function(e){this.message('Media renderer "'+e.get("name")+'" removed')},this),this.listenTo(Wu.Cache.Collections.servers,"add",function(e){this.message('New media server "'+e.get("name")+'" detected')},this),this.listenTo(Wu.Cache.Collections.servers,"remove",function(e){this.message('Media server "'+e.get("name")+'" removed')},this),this.listenTo(Wu.Cache.Models.player,"change:currentPlayingTrack",function(e,t){this.title(t.Title)},this),this.listenTo(Wu.Cache.Models.player,"change:uuid",function(e,t){var i=Wu.Cache.Collections.renderers.get(t);i?this.message('Now playing to "'+i.get("name")+'" renderer'):this.message("No media renderer selected")},this),Socket.on("error",$.proxy(function(e){this.error(e)},this)),Socket.on("tracksInserted",$.proxy(function(){this.message("New tracks inserted")},this)),this.messageStack=[]},title:function(e){window.clearTimeout(this.titleTimeout),$("title").html(e),this.titleTimeout=window.setTimeout(function(){$("title").html("Wu")},4e3)},message:function(e){this.messageStack.push({text:e,type:"message"}),this._show()},error:function(e){this.messageStack.push({text:e,type:"error"}),this._show()},_add:function(e){this.messageStack.push(e),$(".toast").html(e),$(".toast-wrap").show(),window.setTimeout(function(){$(".toast-wrap").hide()},4e3)},_show:function(){if("none"===$(".toast-wrap").css("display")&&this.messageStack.length){var e=this.messageStack.shift();$(".toast-wrap")["error"===e.type?"addClass":"removeClass"]("error").show(),$(".toast").html(e.text),window.setTimeout($.proxy(function(){$(".toast-wrap").hide(),this._show()},this),4e3)}}}),Wu.Views.trackList=Backbone.View.extend({template:JST["track.list"],events:{"click .track-info":"play"},initialize:function(){this.listenTo(Wu.Cache.Models.player,"change:currentPlayingTrack",this.highlight),this.listenTo(this,"inserted",this.highlight),this.listenTo(this,"swipeAway",this.delete),Wu.Mixin.mix(this,Wu.Mixin.swipeAway)},render:function(){var e=this;return this.template({collection:this.collection},function(t,i){e.$el.html(i),e.$("li").length&&e.$("li")[0].scrollIntoView()}),this},unrender:function(){this.stopListening()},highlight:function(){var e=Wu.Cache.Models.player.get("currentPlayingTrack"),t=e?e._id:!1;this.$("li").removeClass("active"),$("#"+t).addClass("active")},play:function(e){if(!$(e.currentTarget).parent().hasClass("transition")){var t=$(e.currentTarget).parent().parent().attr("position");Wu.Cache.Models.player.playByPosition(t,this.model.get("_id"))}},"delete":function(e){var t=this.collection.get(e);t&&t.destroy({error:function(e,t){var i=t.responseText;Wu.Cache.Views.toastMaster.error(i)}})}}),Wu.Models.category=Backbone.Model.extend({ORDER:["Artist","Album","Title"],urlRoot:"/api/categories",initialize:function(){Socket.on("tracksInserted",function(){Wu.Layout.page.trigger("tracksInserted")})},fetch:function(e){var t=this.get("filter");e=e||{},e.data=_.extend({},e.data,{filter:t}),Backbone.Model.prototype.fetch.call(this,e)},filter:function(e,t){var i=this.get("filter")||{},n=this.get("id"),s=_.indexOf(this.ORDER,n);return s++,this.ORDER.length>s?(i[n]=e,this.set("filter",i)):"Title"===n&&(i._id=t),this.ORDER[s]},setCategory:function(e){var t=this.get("filter")||{},i=this.get("id"),n=_.indexOf(this.ORDER,i);for(newIndex=_.indexOf(this.ORDER,e);n>=newIndex;)t[this.ORDER[n]]&&delete t[this.ORDER[n]],n--;t._id&&delete t._id,this.set("filter",t),this.set("id",e)},getTitle:function(){for(var e=this.get("filter")||{},t=this.get("id"),i=_.indexOf(this.ORDER,t);--i>=0;)if(e[this.ORDER[i]])return e[this.ORDER[i]];return!1}}),Wu.Models.directory=Backbone.Model.extend({urlRoot:function(){return"/api/directory/"+this.get("uuid")+"/"},initialize:function(){this.titleMap={}},filter:function(e,t){return t?(this.titleMap[t]=e,this.get("uuid")+"/"+t):!1},getTitle:function(){return this.titleMap[this.get("id")]}}),Wu.Models.player=Backbone.Model.extend({urlRoot:"/api/renderers",idAttribute:"uuid",initialize:function(){var e=this;Socket.on("stateChange",function(t){e.set(t.name,t.value)}),Socket.on("setRendererResult",function(t,i){t?(Wu.Cache.Views.toastMaster.error(t),e.clear()):(e.set("uuid",i),e.fetch())}),Socket.on("rendererRemoved",function(t){e.get("uuid")===t.uuid&&e.clear()})},playByPosition:function(e,t){Socket.emit("playByPosition",e,t)},setRenderer:function(e){Socket.emit("setRenderer",e)}}),Wu.Models.playlist=Backbone.Model.extend({urlRoot:"/api/playlists",idAttribute:"_id"}),Wu.Models.renderer=Backbone.Model.extend({idAttribute:"uuid",urlRoot:"/api/renderers"}),Wu.Models.server=Backbone.Model.extend({idAttribute:"uuid",urlRoot:"/api/servers"}),Wu.Models.tracks=Backbone.Model.extend({idAttribute:"position"}),Wu.Collections.playlists=Backbone.Collection.extend({initialize:function(){Socket.on("rendererAdded",$.proxy(function(){this.fetch()
},this))},model:Wu.Models.playlist,url:"/api/playlists"}),Wu.Collections.renderers=Backbone.Collection.extend({model:Wu.Models.renderer,url:"/api/renderers",initialize:function(){var e=this;Socket.on("rendererAdded",function(t){e.add(t)}),Socket.on("rendererRemoved",function(t){e.remove(this.get(t.uuid))})}}),Wu.Collections.servers=Backbone.Collection.extend({model:Wu.Models.server,url:"/api/servers",initialize:function(){var e=this;Socket.on("serverAdded",function(t){t.path&&(e.pathSet=!0),e.add(t)}),Socket.on("serverRemoved",function(t){e.remove(this.get(t.uuid))}),this.on("change:path",function(){e.pathSet=!0}),this.on("reset",function(){e.each(function(t){t.get("path")&&(e.pathSet=!0)})}),this.pathSet=!1}}),Wu.Collections.tracks=Backbone.Collection.extend({model:Wu.Models.tracks,initialize:function(e){this._id=e.id},url:function(){return"/api/playlists/"+this._id}}),Wu.Routers.Categories=Backbone.Router.extend({routes:{"":"index","category/:id":"show","playlist/:id":"showList","directory/:uuid/:id":"showDir",test:"testDir"},index:function(){this.show("Artist")},show:function(e){var t=Wu.Cache.Models.category;if(t.setCategory(e),"categories"!=Wu.Layout.state){var i=new Wu.Views.categoriesNav({model:t}),n=new Wu.Views.categories({model:t});Wu.Layout.menu.trigger("hideMusic"),t.fetch({success:function(){Wu.Layout.setSubHeader(i),Wu.Layout.setPage(n),Wu.Layout.state="categories"},error:function(){Wu.Cache.Views.toastMaster.error("failed to get category")}})}},showList:function(e){var t,i=Wu.Cache.Collections.playlists.get(e);i?(t=i.get("tracks")||i.set("tracks",new Wu.Collections.tracks({id:e})).get("tracks"),Wu.Layout.state="playlist",Wu.Layout.menu.trigger("showMusic"),t.fetch({success:function(){var e=new Wu.Views.playlistDropdown({model:i}),n=new Wu.Views.trackList({model:i,collection:t,className:"category"});Wu.Layout.setSubHeader(e),Wu.Layout.setPage(n)},error:function(e,t){Wu.Cache.Views.toastMaster.error(t.responseText)}})):Wu.Cache.Views.toastMaster.error("Playlist not found")},showDir:function(e,t){if("directory"!=Wu.Layout.state){Wu.Layout.removeSubHeader();var i=new Wu.Views.directories({model:Wu.Cache.Models.directory});Wu.Layout.setPage(i),Wu.Layout.state="directory"}Wu.Layout.menu.trigger("showMusic"),Wu.Cache.Models.directory.set("uuid",e),Wu.Cache.Models.directory.set({id:t},{silent:!0}),Wu.Cache.Models.directory.trigger("change:id")}}),function(){for(var e=0,t=["ms","moz","webkit","o"],i=0;t.length>i&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[t[i]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[t[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(t){var i=(new Date).getTime(),n=Math.max(0,16-(i-e)),s=window.setTimeout(function(){t(i+n)},n);return e=i+n,s}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)})}(),Wu.Mixin={mix:function(e,t){for(var i,n="_mixin",s=0,o=[];e[n+s];)s++;t.mixID=n+s,e[n]=t,t.view=e,i=_.isFunction(t.events)?t.events():t.events||{},_.each(i,function(i,n){if(!_.isFunction(t[i]))return console.log(i+" is not a function"),void 0;var s=n.split(/\b/);e.$el.on(s[0],s.slice(1).join(""),$.proxy(t[i],t))}),_.extend(e.events,{},o)}},Wu.Mixin.swipeAway={touchable:"ontouchstart"in document.documentElement,events:function(){return map={},map=this.touchable?{"touchstart .swipeEl":"start","touchmove  .swipeEl":"move","touchend   .swipeEl":"end"}:{"mousedown .swipeEl":"start","mousemove .swipeEl":"move","mouseout  .swipeEl":"end","mouseup   .swipeEl":"end"},map["webkitTransitionEnd .swipeEl"]="transitionEnd",map["transitionend .swipeEl"]="transitionEnd",map["click .swipeEl h1"]="undo",map},position:function(e){return e.touches?e.touches[0].pageX:e.pageX},start:function(e){this.cover=$(e.currentTarget).find(".swipeCover"),$(e.currentTarget).hasClass("transition")||(this.active=!0,this.startX=this.position(e),this.pos=0,this.touchable||e.preventDefault())},move:function(e){if(this.active){var t=this.position(e);this.pos=Math.min(0,t-this.startX),(-5>this.pos||this.started)&&(this.cover.css("-webkit-transform","translate3d("+this.pos+"px,0,0)"),this.started=!0)}},end:function(){this.active&&this.started&&(-40>this.pos?(this.cover.parent().addClass("transition"),this.cover.css("-webkit-transform","translate3d(-"+this.cover.width()+"px,0,0)")):0>this.pos&&(this.cover.parent().addClass("transition"),this.cover.css("-webkit-transform","translate3d(0,0,0)"))),this.active=!1,this.started=!1},transitionEnd:function(e){-1!=e.propertyName.indexOf("transform")?"translate3d(0px, 0px, 0px)"===$(e.target).css(e.propertyName)?$(e.currentTarget).removeClass("transition"):$(e.currentTarget).css("opacity",0):"opacity"==e.propertyName&&($(e.currentTarget).parent().hide(),this.view.trigger("swipeAway",$(e.currentTarget).parent().attr("id")))},undo:function(e){e.preventDefault(),$(e.currentTarget).parent().css("-webkit-transform","translate3d(0,0,0)").parent().removeClass("transition").css("opacity",1)}};